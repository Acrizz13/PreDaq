@model IEnumerable<sobee_core.Models.AnalyticsModels.UserViewModel>

@{
    ViewData["Title"] = "User Manager";
    Layout = "~/Views/AdminDashboard/Shared/_Layout.cshtml";
    int rowNumber = 0;
}

<h2>User Manager</h2>


<table class="table">
    <thead>
        <tr>
            <th>#</th>
            <th>Email</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Is Admin</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var user in Model) {
            rowNumber++;
            <tr>
                <td>@rowNumber</td>
                <td>@user.Email</td>
                <td>@user.FirstName</td>
                <td>@user.LastName</td>
                <td>@(user.IsAdmin ? "Yes" : "No")</td>
                <td>
                    <button type="button" class="btn btn-primary edit-button" data-user-id="@user.Id">Edit</button>
                    <button type="button" class="btn btn-danger delete-button" data-user-id="@user.Id">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="close" onclick="closeEditUserModal() data-dismiss=" modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId" name="Id" />
                    <div class="form-group">
                        <label for="editUserName">User Name:</label>
                        <input type="text" id="editUserName" name="UserName" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email:</label>
                        <input type="email" id="editEmail" name="Email" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="editFirstName">First Name:</label>
                        <input type="text" id="editFirstName" name="FirstName" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name:</label>
                        <input type="text" id="editLastName" name="LastName" class="form-control" />
                    </div>
                    <!-- Add more fields as needed -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditUserModal() data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateUserBtn">Update User</button>
                </div>
            </form>
        </div>
    </div>
</div>




<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                <button type="button" class="close" onclick="closeDeleteUserModal() data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user?</p>
                <input type="hidden" id="deleteUserId" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteUserModal() data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteUserBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>

        function closeEditUserModal() {
            $('#editUserModal').modal('hide');
        }

        function closeDeleteUserModal() {
            $('#deleteUserModal').modal('hide');
        }


        $(document).on('click', '.edit-button', function () {
            var userId = $(this).data('user-id');
            var userRow = $(this).closest('tr');

            var userName = userRow.find('td:eq(1)').text(); // Assuming the username is in the second column
            var email = userRow.find('td:eq(2)').text(); // Assuming the email is in the third column
            var firstName = userRow.find('td:eq(3)').text(); // Assuming the first name is in the fourth column
            var lastName = userRow.find('td:eq(4)').text(); // Assuming the last name is in the fifth column

            $('#editUserId').val(userId);
            $('#editUserName').val(userName);
            $('#editEmail').val(email);
            $('#editFirstName').val(firstName);
            $('#editLastName').val(lastName);

            $('#editUserModal').modal('show');
        });

        $('#editUserModal').on('hidden.bs.modal', function () {
            $(this).find('form')[0].reset();
        });

        $(document).on('click', '#updateUserBtn', function () {
            var form = $('#editUserForm');
            var url = '@Url.Action("EditUser", "AdminDashboard")'; // Replace with the appropriate action method URL
            var data = form.serialize();

            $.ajax({
                type: 'POST',
                url: url,
                data: data,
                success: function (response) {
                    if (response.success) {
                        $('#editUserModal').modal('hide');
                        // Optionally, you can update the user's row in the table with the new data
                        // or reload the entire table
                    } else {
                        alert('Form submission failed. Please try again.');
                    }
                },
                error: function () {
                    alert('An error occurred while submitting the form.');
                }
            });
        });

        $(document).on('click', '.delete-button', function () {
            var userId = $(this).data('user-id');
            $('#deleteUserId').val(userId);
            $('#deleteUserModal').modal('show');
        });

        $(document).on('click', '#confirmDeleteUserBtn', function () {
            var userId = $('#deleteUserId').val();
            var url = '@Url.Action("DeleteUser", "AdminDashboard")';

            $.ajax({
                url: url,
                type: 'POST',
                data: { id: userId },
                success: function (response) {
                    console.log(userId);

                    if (response.success) {
                        $('#deleteUserModal').modal('hide');
                        // Optionally, you can remove the deleted user's row from the table
                        // or reload the entire table
                    } else {
                        alert('Failed to delete the user.');
                    }
                },
                error: function () {
                    console.log(userId);
                    alert('An error occurred while deleting the user.');
                }
            });
        });

    </script>
}